# 要件定義：Codex用ローカルターミナル（Side Panel）

作成日時：2025-12-26 18:18（UTC+09:00）

## 目的（Why）

ブラウザ上で範囲選択したテキスト等をきっかけに、ブラウザ拡張のサイドパネル内でローカルの `zsh` ターミナルを操作できるようにする。

狙い：
- ブラウザを離れずに `codex` を含むローカルコマンドを実行できること
- 既存の「ローカルTerminalで `codex` を起動する」運用と同等の条件（同一端末・同一ユーザー・同一ホーム）で動かすこと

## ユースケース（What / How）

- サイドパネルにターミナル画面を表示する
- ユーザーが入力して Enter を押したときのみ送信され、ローカルで実行される
- 出力（stdout/stderr）がサイドパネルに表示される
- ユーザーが `codex` と入力して起動できる

## スコープ（MVP）

### MUST（必須）

- サイドパネル（Chrome Extension MV3）にターミナルUIを表示できる
- ターミナルUIで文字入力・Enter送信・Backspace・コピー＆ペーストができる
- ローカルで `zsh` を別セッションとして起動し、入出力を中継できる
- ユーザー操作（Enter/送信）以外でコマンド実行されない
- `codex` を通常のターミナル同様に起動できる（ローカルでインストール済み前提）

### SHOULD（できれば）

- 起動時の作業ディレクトリを固定（初期値：`/tmp/chrome_extension_codex_terminal` を想定）＋ **選択肢として `~/Downloads` も選べるUI** を用意
- 文字表示（ANSIカラー等）が崩れない
- 1セッション中に複数コマンドを連続実行できる

### WON'T（MVPではやらない）

- 既存のTerminal.appの“既に開いているセッション”の埋め込み・共有
- 複数ユーザーへの配布を前提としたインストーラ提供
- Webページ側からの自動実行（選択範囲を自動送信して即実行など）

## アーキテクチャ概要

### コンポーネント

- **Browser Extension（MV3）**
  - Side Panel UI
  - ターミナル描画（例：xterm.js など）
  - Native Messaging でローカルホストへ接続

- **Native Messaging Host（ローカルアプリ）**
  - Chrome Native Messaging のプロトコルで拡張とJSON通信
  - PTY（擬似端末）を作り、`zsh` を起動
  - 入力をPTYへ流し、出力を拡張へ返す

### データフロー（概念）

1. 拡張のSide Panelでキー入力
2. 入力イベントをNative Hostへ送信
3. Native HostがPTYへ書き込み
4. PTY出力をNative Hostが受け取り
5. 出力を拡張へ送信
6. 拡張がターミナルUIへ描画

## セキュリティ/安全設計（最低限）

- Native Messaging Hostの `allowed_origins` は拡張IDで固定（ワイルドカード不可）
- Content Script から直接 Native Host を叩かせない（必ず Service Worker/Side Panel を経由）
- 初期MVPは「ユーザー操作でのみ送信」
- 可能なら「実行前プレビュー」や「実行中表示」を入れる

### 決定済みの前提（2025-12-26 合意）
- セッション数：MVPは **単一セッション**（タブなし）
- キー入力：Ctrl+C/S/Z 等は **PTYへ素通し**
- 大量出力：特別な制限なし（必要なら後で分割送信を検討）

## 受け入れ条件（Acceptance Criteria）

- サイドパネルで `echo hello` を実行でき、出力が表示される
- サイドパネルで `codex` を起動でき、通常のターミナルと同様に対話できる
- ブラウザを閉じても、意図せずコマンドが実行されない

## 既知の制約/リスク

- Native Messaging Hostのインストール手順がOS依存（macOS前提でまず作る）
- 出力が大きい場合、メッセージ分割などが必要
- 安全設計を誤ると、Webページ経由でローカル実行できる危険がある

## 未決事項（質問）

- 起動ディレクトリ（固定にするか、最後のディレクトリを復元するか）
- サイドパネルのデザイン（最小：黒背景 + 等幅フォント）
- セッションを複数持つ必要があるか（タブ/セッション管理）
